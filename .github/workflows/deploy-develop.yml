# name: Deploy to Dev & Test

# on:
#   pull_request:
#     branches:
#       - develop
#   push:
#     branches:
#       - develop

# permissions:
#   contents: read
#   actions: read
#   checks: write
#   id-token: write

# jobs:
#   build-and-test:
#     name: Build and Test
#     runs-on: ubuntu-latest

#     steps:
#     # --------------------------------------------------
#     # Checkout
#     # --------------------------------------------------
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Setup .NET
#       uses: actions/setup-dotnet@v4
#       with:
#         dotnet-version: '8.0.x'

#     - name: Restore
#       run: dotnet restore

#     # --------------------------------------------------
#     # Build & Test
#     # --------------------------------------------------
#     - name: Build
#       run: dotnet build --no-restore --configuration Release

#     - name: Run Unit Tests
#       run: |
#         dotnet test \
#           --configuration Release \
#           --logger "trx" \
#           --results-directory TestResults \
#           --no-build

#     - name: Publish Test Results
#       if: always()
#       uses: dorny/test-reporter@v1
#       with:
#         name: Unit Tests
#         path: TestResults/*.trx
#         reporter: dotnet-trx

#     - name: Run Tests with Coverage
#       run: |
#         dotnet test \
#           --collect:"XPlat Code Coverage" \
#           --results-directory TestResults \
#           --configuration Release

#     - name: Upload Coverage
#       uses: actions/upload-artifact@v4
#       with:
#         name: coverage
#         path: TestResults/**/coverage.cobertura.xml

#     - name: Publish Coverage Summary
#       uses: irongut/CodeCoverageSummary@v1.3.0
#       with:
#         filename: TestResults/**/coverage.cobertura.xml
#         badge: true
#         format: markdown
#         output: both

#     # --------------------------------------------------
#     # Publish Artifact (only on push to develop)
#     # --------------------------------------------------
#     - name: Publish Application
#       if: github.event_name == 'push'
#       run: dotnet publish src/HelloWorldApi/HelloWorldApi.csproj --configuration Release --output ./publish

#     - name: Upload Artifact
#       if: github.event_name == 'push'
#       uses: actions/upload-artifact@v4
#       with:
#         name: webapp-artifact
#         path: ./publish

#   # --------------------------------------------------
#   # Deploy to DEV Environment
#   # --------------------------------------------------
#   deploy-dev:
#     name: Deploy to DEV
#     runs-on: ubuntu-latest
#     needs: build-and-test
#     if: github.event_name == 'push'
#     environment:
#       name: dev
#       url: https://${{ vars.WEBAPP_NAME_DEV }}.azurewebsites.net

#     steps:
#     - name: Download Artifact
#       uses: actions/download-artifact@v4
#       with:
#         name: webapp-artifact
#         path: ./publish

#     - name: Azure Login
#       uses: azure/login@v2
#       with:
#         client-id: ${{ secrets.CLIENT_ID }}
#         tenant-id: ${{ secrets.TENENT_ID }}
#         subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

#     - name: Deploy to Azure Web App (DEV)
#       uses: azure/webapps-deploy@v3
#       with:
#         app-name: ${{ secrets.WEBAPP_NAME_DEV }}
#         package: ./publish

#   # --------------------------------------------------
#   # Deploy to TEST Environment
#   # --------------------------------------------------
#   deploy-test:
#     name: Deploy to TEST
#     runs-on: ubuntu-latest
#     needs: deploy-dev
#     if: github.event_name == 'push'
#     environment:
#       name: test
#       url: https://${{ vars.WEBAPP_NAME_TEST }}.azurewebsites.net

#     steps:
#     - name: Download Artifact
#       uses: actions/download-artifact@v4
#       with:
#         name: webapp-artifact
#         path: ./publish

#     - name: Azure Login
#       uses: azure/login@v2
#       with:
#         client-id: ${{ secrets.CLIENT_ID }}
#         tenant-id: ${{ secrets.TENENT_ID }}
#         subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

#     - name: Deploy to Azure Web App (TEST)
#       uses: azure/webapps-deploy@v3
#       with:
#         app-name: ${{ secrets.WEBAPP_NAME_TEST }}
#         package: ./publish


name: Deploy to Dev & Test

on:
  pull_request:
    branches:
      - develop
  push:
    branches:
      - develop

permissions:
  contents: read
  actions: read
  checks: write
  id-token: write   # REQUIRED for Azure OIDC
  security-events: write
  issues: write     # REQUIRED for ZAP to create issues

# ==================================================
# BUILD + UNIT TEST + ARTIFACT
# ==================================================
jobs:
  build-and-test:
    name: Build and Unit Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Run Unit Tests
      run: |
        dotnet test \
          --configuration Release \
          --logger "trx" \
          --results-directory TestResults \
          --no-build

    - name: Publish Unit Test Results
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Unit Tests
        path: TestResults/*.trx
        reporter: dotnet-trx

    - name: Run Tests with Coverage
      run: |
        dotnet test \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults \
          --configuration Release

    - name: Upload Coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage
        path: TestResults/**/coverage.cobertura.xml

    - name: Publish Application
      if: github.event_name == 'push'
      run: |
        dotnet publish Calculator/Calculator.csproj \
          --configuration Release \
          --output ./publish

    - name: Upload Application Artifact
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

# ==================================================
# DEPLOY TO DEV + INTEGRATION + DAST + SECURITY GATE
# ==================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'

    environment:
      name: dev
      url: https://${{ vars.WEBAPP_NAME_DEV }}.azurewebsites.net

    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

    - name: Azure Login via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.CLIENT_ID }}
        tenant-id: ${{ secrets.TENENT_ID }}
        subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

    - name: Deploy to Azure Web App (DEV)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.WEBAPP_NAME_DEV }}
        package: ./publish

    # -------------------------------
    # Integration Tests
    # -------------------------------
    - name: Checkout code for Integration Tests
      uses: actions/checkout@v4

    - name: Setup .NET for Integration Tests
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore Integration Tests
      run: dotnet restore Calculator.IntegrationTests/Calculator.IntegrationTests.csproj

    - name: Run Integration Tests
      run: |
        dotnet test Calculator.IntegrationTests/Calculator.IntegrationTests.csproj \
          --configuration Release \
          --logger "trx" \
          --results-directory IntegrationTestResults

    - name: Publish Integration Test Results
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Integration Tests
        path: IntegrationTestResults/*.trx
        reporter: dotnet-trx

    # -------------------------------
    # DAST Security Testing
    # -------------------------------
    - name: Create ZAP workspace
      run: |
        mkdir -p ${{ github.workspace }}/zap-reports
        chmod 777 ${{ github.workspace }}/zap-reports

    - name: Run OWASP ZAP Baseline Scan
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/zap-reports:/zap/wrk:rw \
          -u root \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py \
          -t https://${{ vars.WEBAPP_NAME_DEV }}.azurewebsites.net \
          -r zap-report.html \
          -J zap-report.json \
          -w zap-report.md \
          -a || true

    - name: Copy ZAP Reports to workspace
      run: |
        if [ -d "${{ github.workspace }}/zap-reports" ]; then
          cp -f ${{ github.workspace }}/zap-reports/zap-report.* ${{ github.workspace }}/ || true
        fi


    # -------------------------------
    # Security Threshold Enforcement
    # -------------------------------
    - name: Check DAST Results
      run: |
        if [ -f zap-report.html ]; then
          echo "üìä Analyzing ZAP scan results..."
          
          if grep -q "Critical" zap-report.html; then
            echo "‚ùå CRITICAL vulnerabilities detected - Deployment blocked!"
            exit 1
          elif grep -q "High" zap-report.html; then
            echo "‚ö†Ô∏è HIGH severity vulnerabilities detected - Review recommended"
            echo "Continuing deployment..."
          else
            echo "‚úÖ No Critical or High vulnerabilities detected"
          fi
        else
          echo "‚ö†Ô∏è ZAP report not found, skipping threshold check"
        fi


    # -------------------------------
    # Collect Results
    # -------------------------------
    - name: Upload ZAP Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: zap-security-reports
        path: |
          ${{ github.workspace }}/zap-report.html
          ${{ github.workspace }}/zap-report.json
          ${{ github.workspace }}/zap-report.md
        if-no-files-found: warn

    - name: Upload Deployment & Security Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dev-deployment-results
        path: |
          TestResults/**
          IntegrationTestResults/**
        if-no-files-found: warn

# ==================================================
# DEPLOY TO TEST (PROMOTION GATE)
# ==================================================
  deploy-test:
    name: Deploy to TEST
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.event_name == 'push'

    environment:
      name: test
      url: https://${{ vars.WEBAPP_NAME_TEST }}.azurewebsites.net

    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

    - name: Azure Login via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.CLIENT_ID }}
        tenant-id: ${{ secrets.TENENT_ID }}
        subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

    - name: Deploy to Azure Web App (TEST)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.WEBAPP_NAME_TEST }}
        package: ./publish
